name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate patterns
        id: validate
        run: |
          set +e
          OUTPUT=$(node scripts/validate-patterns.js 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          # 멀티라인 출력을 위한 처리
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "output<<$EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          exit $EXIT_CODE

      - name: Comment on PR (failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.validate.outputs.output }}`;

            const body = [
              '## ❌ 패턴 검증 실패',
              '',
              '자동 검증에서 오류가 발견되었습니다. 아래 내용을 확인하고 수정해주세요.',
              '',
              '```',
              output,
              '```',
              '',
              '### 체크리스트',
              '- [ ] JSON 파일 필수 필드 확인 (id, title, title_ko, category, status)',
              '- [ ] 카테고리/상태 값이 유효한지 확인',
              '- [ ] 파일명과 id가 일치하는지 확인',
              '- [ ] README 패턴 수가 실제와 일치하는지 확인',
              '',
              '---',
              '_이 코멘트는 CI에서 자동 생성되었습니다._'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  build:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        id: build
        run: |
          set +e
          OUTPUT=$(npm run build 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "output<<$EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          exit $EXIT_CODE

      - name: Comment on PR (build failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.build.outputs.output }}`;

            // 출력이 너무 길면 마지막 부분만 표시
            const maxLen = 3000;
            const truncated = output.length > maxLen
              ? '...(truncated)\n\n' + output.slice(-maxLen)
              : output;

            const body = [
              '## ❌ 빌드 실패',
              '',
              '빌드 과정에서 오류가 발생했습니다.',
              '',
              '```',
              truncated,
              '```',
              '',
              '---',
              '_이 코멘트는 CI에서 자동 생성되었습니다._'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Comment on PR (success)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## ✅ CI 통과',
              '',
              '모든 검증과 빌드가 성공적으로 완료되었습니다.',
              '',
              '- ✅ 패턴 JSON 검증',
              '- ✅ README 문서 검증',
              '- ✅ Astro 빌드',
              '',
              '머지 준비가 완료되었습니다.',
              '',
              '---',
              '_이 코멘트는 CI에서 자동 생성되었습니다._'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
